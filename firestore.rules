rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read/write their own profile (works for anon + registered)
    match /users/{userId} {
      allow read:   if request.auth != null;
      allow write:  if request.auth != null && request.auth.uid == userId;
    }

    // Mood logs — user can only access their own
    match /moodLogs/{logId} {
      allow read, delete: if request.auth != null && request.auth.uid == resource.data.uid;
      allow create:       if request.auth != null && request.auth.uid == request.resource.data.uid;
    }

    // Chat history — user can only access their own
    match /chatHistory/{messageId} {
      allow read:   if request.auth != null && request.auth.uid == resource.data.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
    }

    // Community posts — must be signed in (anon users allowed to read, registered to post)
    match /communityPosts/{postId} {
      allow read:   if request.auth != null;
      allow create: if request.auth != null && !request.auth.token.firebase.sign_in_provider.matches('anonymous')
                       && request.auth.uid == request.resource.data.uid;
      allow update: if request.auth != null; // likes & replies
    }
  }
}
